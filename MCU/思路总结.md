### 串口收发函数

#### 总体思路
```
总体程序设计思路
    串口初始化函数
    发送一个字节函数
    接收一个字节函数

详细程序设计思路（每个函数里面应该怎么写程序）
    初始化函数
    {
        // GPIO 初始化
        // 端口时钟使能
        // 选择端口模式寄存器(复用)
        // 输出速度寄存器
        // 输出类型寄存器
        // 上下拉选择
        // 复用功能寄存器

        // 串口初始化
        // 控制器使能打开
        // 波特率寄存器设置
        // 控制寄存器过采样
        // 控制寄存器字长
        // 控制寄存器发送使能
        // 控制寄存器接收使能
        // 控制寄存器停止位
        // 控制寄存器使能打开

    }
```

#### 发送函数
```
    发送一个字节函数
    {
        // 等待发送一个字节已完成（发送寄存器已自动置1）
        // 将发送的一个字节赋值给数据寄存器
        
        // 发送状态寄存器
        // 接收状态寄存器
    }

    u8 接收一个字节函数
    {
        // 等待接收一个字节已完成（接收寄存器已自动置1）
        // 读取接数据存器的值赋值给变量
        // 返回接收值
    }
```


#### 相关函数
```

u8 str[] = "Hello World \r\n";

// 发送一个字符串函数
无返回值
void usart1_send_str(u8 *str)
{
    while(*str != '\0')
    {
        usart1_send_byte(*str);
        str++;
    }
}

u8 str[10];
// 接收一个字符串函数
// 无返回值
void usart1_rec_str(u8 *str)
{

    while(1)
    {
        *str = usart1_rec_byte();
        if (*str == '#')
        {
            break;
        }
        str++;
    }

    *str = '\0';
}

```


### 中断

#### 中断服务函数格式
```
// 串口中断函数
void 函数名(void)
{

    // 如果是接收中断触发了，状态寄存器对应的
    {
        // 清除对应标志位
        // 执行事件
    }

    // 如果是空闲触发了中断， 判断状态寄存器对应的值，置 1
    {
        // 清除空闲标志位
        // 执行事件
    }
}

// 中断服务函数
void 函数名称(void)
{
    // 判断中断的信号类型，以及对应的标志位 满足
    {
        // 清除对应的标志位
        // 执行紧急事件
    }
}

```

#### 外部中断
```
总计思路
EXTI配置
{
    // GPIO 初始化
    // NVIC 初始化
    // 外部中断初始化
}
EXTI中断服务函数
{

}

具体思路
EXTI配置
{
    /* GPIO 初始化 */
    // 端口时钟使能
    // 端口模式寄存器 通用输入
    // 端口上下拉配置器 无上下拉

    /* NVIC 初始化 */
    // NVIC 优先级组配置
    // 优先级编码值计算
    // 确认中断源
    // 使能NVIC中断源响应通道

    /* 外部中断线初始化 */
    // 系统配置控制器时钟使能
    // 根据对应的GPIO口，配置映射到具体的中断线上
    // 上升沿或者下降沿配置 - 触发器设置
    
    // 中断屏蔽寄存器 - 使能中断线
}

中断服务函数
{
    /* 外部中断函数实现 */
    // 判断是那根EXTI线触发 读取-挂起寄存器
    {
        // 清标志位 
    }
    // 紧急事件
}
```


#### 延时思路
```
延时
{
    // 选择时钟源
    // 写入重载值（需要计数的数） 记得减1
    // 使能计数器
    // 清空当前值寄存器
    // 读取寄存器16号位，自动置1
    // 关闭定时器
}
```

#### 通用定时器延时思路
```
初始化延时定时器
{
    // 开启时钟使能 APB1
    /* 控制寄存器CR1 */ 
    // 自动重载使能 7位 影子寄存器
    // 计数器单次还是循环 3号位
    // 更新请求源使能 2位 是否配置中断
    // 是否配置更新事件 1号位 0 是
    // 预分频器 写入值 减 1.
    // 自动重载寄存器 
    // 事件生成寄存器 （手动更新）
    // 状态寄存器清0.
    // 计数使能 0位
    // 等待状态寄存器置 1 
}
```


#### 通用定时器定时中断思路
```
初始化思路
{
    // 开启时钟使能 APB1
    /* 控制寄存器 CR1 */
    // 重载预装载使能 7号位（影子寄存器）
    // 单次还是循环 3号位 写0
    // 更新请求源（中断）2号位 写0
    // 更新使能，1号位，写0.
    // 中断使能寄存器 DIER 8号位 置1
    // 预分频器 PSC, 需要减1
    // 状态寄存器清0.
    // 自动重载寄存器，需要减1.
    // 事件生成器（手动更新）EGR 写1
    // 计数使能 0位
}

中断服务函数
{
    // 清除标志位。
    // 读取状态寄存器的值 
    // 紧急事件
}
```

#### PWM 占空比
```
  // 输出PWM波形 配置使用相关的位
  // CR1 控制寄存器
    // 7号位-自动重载预装载使能 1
    //  6:5 号位 - 中心对齐模式选项 00
    //  4号位 - 方向 0
    //  3号位 - 单脉冲模式 0
    // 1号位 - 更新使能 0
    //  0号位 - 计数器使能 1 末尾打开
  // SMCR 从模式控制寄存器
    //  2:0 号位 - 从模式选择 000
  // EGR 事件生成寄存器
    // 0号位 - 更新生成 0 (手动更新)
  // CCMR1 捕获/比较模式寄存器
    // 1:0 位 - 捕获/比较1选择 00
    // 3号位 - 输出比较1预装载使能 1
    // 6:4号位 - 输出比较1模式 110
  // CCER 捕获/比较使能寄存器
    // 0号位 - 捕获/输出1输出使能 1
    //  1号位 - 捕获/输出1输出极性 输出 1
```


#### 通用定时器 输入捕获
```
// 整体思路
整体思路
{
    // GPIO 初始化
    // 通用定时器初始化
    // NVIC 中断初始化 
}

详细思路
输入捕获详细思路{
    /* GPIO 初始化 */
    //端口时钟使能
    // 端口模式配置 - 复用
    // 端口上下拉 无上拉
    // 复用功能配置

    /* 通用定时器初始化 */
    // 定时器时钟使能
    /** CR1 控制寄存器 **/
    // 滤波所用的频率-不分频
    // 影子寄存器
    // 边沿对齐模式
    // 递增计数
    // 循环计数
    // 开启产生中断
    // 开启产生更新事件
    /** SMCR 从模式寄存器 **/
    // 时钟源选择 - 内部时钟
    /** DIER 中断使能寄存器 **/
    // 通道1捕获中断使能
    // 更新中断使能
    /** CCMR1 捕获/比较寄存器 **/
    // 通道1捕获TI1信号
    // 通道1无分频
    // 通道1滤波采样
    /** CCER 捕获/比较使能寄存器 **/
    // 使能通道1捕获
    // 上升沿/下降沿捕获
    /** PSC 预分频器 **/
    // 设置时钟分频值
    /** ARR 自动重载寄存器 **/
    // 设置重载值
    /** EGR 事件生成寄存器 **/
    // 手动生成更新事件
    // 人为更新清除标志位   
    /* NVIC 中断初始化 */
    // 优先级分组 --- 在主函数
    // 计算优先级编码值
    // 设置具体中断源
    // 是能NVIC响应通道

    // 使能计数开启 
} 

中断服务函数
{
    // 判断是否是更新中断
    {
        // 清除标志位
        // 紧急事件 计数
    }

    // 判断是否是捕获中断
    {
        // 清除捕获标志位
        // 紧急事件
        // 判断是第一个边沿触发
        {
            // 记录第一个边沿值
            // 切换到第二个边沿
        }
        // 判断是第二个边沿
        {
            // 记录第二个边沿
            // 计算脉宽
            // 切换到第一个边沿
        }
    }
}

详细思路
{
    // GPIO 配置
    // 开启时钟使能
    // 端口模式寄存器配置 复用
    // 上下拉选择
    // 复用寄存器配置

    // 定时器配置
    // 开启定时器使能
    // CR1 控制寄存器
    // SMCR 从模式控制寄存器
    // DIER 中断使能寄存器
    // CCMR1 捕获/比较模式寄存器
    // CCER 捕获/比较使能寄存器
    // PSC 预分频器
    // ARR 自动重载寄存器
    // EGR 事件生成寄存器

    // 中断配置 NVIC
    // 优先级分组配置
    // 计算优先级编码
    // 确定中断源
    // 使能NVIC响应通道
}
```

### ADC
#### ADC 模数转换
```
总体思路
查询{
    /* GPIO配置 */
    /* ADC配置 */
    /* 获取数据转换函数 */
}

中断方式{
    /* GPIO配置 */
    /* ADC配置 */
    /* 中断优先级设置 */
    /* 中断服务函数 */
}

详细思路
初始化函数{
    /* GPIO配置 */
    // 时钟使能开启
    // 端口模式寄存器模拟输入
    /* ADC配置 */
    // ADC时钟使能
    // CR1 控制寄存器 
    // 位25:24 RES 分辨率 00
    // 位 8 SCAN: 扫描模式 1
    // 位 5 EOCIE: EOC 中断使能，需要时候开启
    // CR2 控制寄存器 
    // 位 11 ALIGN: 数据对齐 0 右对齐
    // 位 10 EOCS:结束转换选择 1 每个规则转换结束时将EOC置1
    // 位 1 CONT: 连续转换 0 单次转换
    // SMPR1 采样时间寄存器
    // 位 26:0 SPMX[2:0]：通道X采样时间 111 480个周期
    // SQR1 规则序列寄存器
    // 位 23:20 L[3:0] 规则通道序列长度
    // 位 SQX[4:0] 规则序列中的第X个转换
    // CCR 通用控制寄存器
    // 位 17:16 ADCPRE:ADC 预分频器 00 PCLK 2 分频 
    // 注入或者规则开启使能
    // CR2 位 0 ADON: ADC转换使能 1 开启
}

转换函数
{
    // CR2 位 30 SWSTART：开始转换规则通道 1 开始
    // SR 状态寄存器
    // 位 1 EOC：规则通道转换结束 
    // CR2 开始转换规则通道
    // 等待转换完成
    // 获取转换数据
}

中断服务函数
{
    // 判断是否转换完成
    // 清除标志位
    // 查询转换数据
}
```


